<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MindAR Video Autoplay</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; background: black; }
    canvas { position: fixed; top: 0; left: 0; }
  </style>
</head>
<body>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Detect iOS
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const videoSrc = isIOS ? "circuit_1.mp4" : "circuit_3.webm";

  // Create video element immediately
  const video = document.createElement("video");
  video.src = videoSrc;
  video.muted = true;
  video.playsInline = true;
  video.autoplay = true;
  video.loop = true;
  video.crossOrigin = "anonymous";

  document.body.appendChild(video);

  // Start playing immediately
  const playPromise = video.play();

  if (playPromise !== undefined) {
    playPromise.then(() => {
      // Once video is playing, init MindAR
      startMindAR(video);
    }).catch(err => {
      console.warn("Autoplay blocked:", err);
    });
  } else {
    // Fallback if promise not supported
    startMindAR(video);
  }

  function startMindAR(videoEl) {
    const mindarThree = new window.MINDAR.IMAGE.MindARThree({
      container: document.body,
      imageTargetSrc: "targets.mind",
    });

    const { renderer, scene, camera } = mindarThree;

    // Lighting
    const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
    scene.add(light);

    // Video texture
    const texture = new THREE.VideoTexture(videoEl);
    texture.minFilter = THREE.LinearFilter;
    texture.magFilter = THREE.LinearFilter;
    texture.format = THREE.RGBFormat;

    // Plane geometry for hologram
    const geometry = new THREE.PlaneGeometry(1, 0.5625);
    const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
    const plane = new THREE.Mesh(geometry, material);
    plane.position.set(0, 0.5, 0); // adjust height
    plane.rotation.x = -Math.PI / 2; // tilt upright

    const anchor = mindarThree.addAnchor(0);
    anchor.group.add(plane);

    mindarThree.start();
    renderer.setAnimationLoop(() => {
      renderer.render(scene, camera);
    });
  }
});
</script>
</body>
</html>
