<script>
document.addEventListener("DOMContentLoaded", async () => {
  const container = document.querySelector("#container");
  const overlay = document.createElement("div");
  overlay.id = "tap-overlay";
  overlay.innerHTML = `
    <div>Tap to Start AR Experience</div>
    <div id="status">Initializing...</div>
  `;
  container.appendChild(overlay);

  // 1. First check for target file
  const statusEl = document.getElementById("status");
  try {
    const targetExists = await fetch("./targets (1).mind").then(r => r.ok);
    if (!targetExists) throw new Error("Target file missing");
  } catch (e) {
    statusEl.textContent = "Error: Missing AR target file";
    return;
  }

  // 2. Initialize MindAR
  const mindarThree = new window.MINDAR.IMAGE.MindARThree({
    container: container,
    imageTargetSrc: "./targets (1).mind",
    filterMinCF: 0.05,
    filterBeta: 0.15,
  });

  // 3. Set up scene (your existing working code)
  const { renderer, scene, camera } = mindarThree;
  const anchor = mindarThree.addAnchor(0);
  
  // [Keep your existing pngPlane code...]

  // 4. Initialize video with better error handling
  statusEl.textContent = "Loading video...";
  const videoInit = await initVideo();
  if (!videoInit) {
    statusEl.textContent = "Error loading video";
    return;
  }

  const { video, material } = videoInit;
  const videoPlane = new THREE.Mesh(
    new THREE.PlaneGeometry(1.5, 1.5),
    material
  );
  anchor.group.add(videoPlane);

  // 5. Start on user interaction
  overlay.addEventListener("click", async () => {
    try {
      statusEl.textContent = "Starting camera...";
      await mindarThree.start();
      
      statusEl.textContent = "Starting video...";
      await video.play();
      
      overlay.style.display = 'none';
      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    } catch (err) {
      console.error("Start error:", err);
      statusEl.textContent = `Error: ${err.message}`;
      
      // Special laptop fix - sometimes needs double start
      if (/mac|win/.test(navigator.platform.toLowerCase())) {
        setTimeout(async () => {
          try {
            await mindarThree.start();
            await video.play();
            overlay.style.display = 'none';
          } catch (e) {
            statusEl.textContent = "Still stuck? Refresh page";
          }
        }, 500);
      }
    }
  });

  // Try autostart on non-mobile
  if (!/mobi/i.test(navigator.userAgent)) {
    overlay.click(); // Simulate click
  }
});
</script>
